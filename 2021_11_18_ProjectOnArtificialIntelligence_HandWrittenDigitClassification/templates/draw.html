{% extends 'base.html' %}


{% block head %}
    <title>Digit Predictor</title>
{% endblock %}


{% block body %}
    <div class="content">
        <h1>Digit Classifier</h1>
        <h3>Digit Classification from Drawing</h3>
        <div id="img"></div>
        <canvas id="myCanvas"></canvas>
        <div><button id="getImg">Get Image</button><button id="clearCanvas">Clear Canvas</button></div>
        <a href="/"><button>Predict From MNIST Datasets</button></a>
        <script>
            $('#getImg').click(function() {
                $('#getImg').hide();
                $('#clearCanvas').addClass('fw');
                var image = new Image();
                // var pngUrl = canvas.toDataURL("image/png");
                var pngUrl = canvas.toDataURL("image/jpg").split(';base64,')[1];
                $('#img').html('<img id="original" src="data:image/png;base64,' + pngUrl + '"\ width="150px">');
                $('#myCanvas').hide();
                data = {
                    'img64': pngUrl
                };
                $.post('/draw_api', data, function (response) {
                    // Response div goes here.
                    var pingBack = response;
                    var resp = $.parseJSON(pingBack);
                    // print(resp);
                    $('#img').prepend('<h3>Prediction: ' + resp['pred'][1] + '</h3>');
                    $('#img').append('<img id="reduced" src="data:image/png;base64,' + resp['b64'] + '"\ width="150px">');

                })
            });
            $('#clearCanvas').click(function() {
                clear();
                $('#getImg').show();
                $('#clearCanvas').removeClass('fw');
                $('#img').html('');
                $('#myCanvas').show();
            })
            // wait for the content of the window element
            // to load, then performs the operations.
            // This is considered best practice.
            window.addEventListener('load', ()=>{
                resize(); // Resizes the canvas once the window loads
                clear();
                document.addEventListener('mousedown', startPainting);
                document.addEventListener('mouseup', stopPainting);
                document.addEventListener('mousemove', sketch);
                window.addEventListener('resize', resize);
            });
                    
                const canvas = document.querySelector('#myCanvas');
                
                // Context for the canvas for 2 dimensional operations
                const ctx = canvas.getContext('2d');
                    
                // Resizes the canvas to the available size of the window.
                function resize(size='300'){
                // ctx.canvas.width = window.innerWidth;
                // ctx.canvas.height = window.innerHeight;
                ctx.canvas.width = size;
                ctx.canvas.height = size;
                }
                    
                // Stores the initial position of the cursor
                let coord = {x:0 , y:0};
                
                // This is the flag that we are going to use to
                // trigger drawing
                let paint = false;
                    
                // Updates the coordianates of the cursor when
                // an event e is triggered to the coordinates where
                // the said event is triggered.
                function getPosition(event){
                coord.x = event.clientX - canvas.offsetLeft;
                coord.y = event.clientY - canvas.offsetTop;
                }
                
                // The following functions toggle the flag to start
                // and stop drawing
                function startPainting(event){
                paint = true;
                getPosition(event);
                }
                function stopPainting(){
                paint = false;
                }

                function clear() {
                    ctx.beginPath();
                    ctx.lineWidth = 500;
                    ctx.lineCap = 'round';
                    ctx.strokeStyle = 'white';
                    ctx.moveTo(150, 150);
                    ctx.lineTo(150, 150);
                    ctx.stroke();
                }
                    
                function sketch(event){
                if (!paint) return;
                ctx.beginPath();
                    
                ctx.lineWidth = 54;
                
                // Sets the end of the lines drawn
                // to a round shape.
                ctx.lineCap = 'round';
                    
                ctx.strokeStyle = 'black';
                    
                // The cursor to start drawing
                // moves to this coordinate
                ctx.moveTo(coord.x, coord.y);
                
                // The position of the cursor
                // gets updated as we move the
                // mouse around.
                getPosition(event);
                
                // A line is traced from start
                // coordinate to this coordinate
                ctx.lineTo(coord.x , coord.y);
                    
                // Draws the line.
                ctx.stroke();
                }
    
        </script>
    </div>
{% endblock %}